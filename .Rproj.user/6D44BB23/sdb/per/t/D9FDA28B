{
    "collab_server" : "",
    "contents" : "library(tidyverse)\nlibrary(data.table)\nlibrary(stringi)\nlibrary(readxl)\nlibrary(arules)\n\n# A[,.n,.(1，2.)]\n# A[!DUPLICATED(A[1:2])]\n#xlsx:\ntem\n# dplyr::distinct()\n# fread(\"F:\\\\20180806\\\\aproiri\\\\18S56\\\\data\\\\180730_180807.csv\",encoding = 'UTF-8',skip=19)%>% as.data.table()\nget_All_da <- function(base_path){\n  all_paths <- base_path %>% list.files() %>% map_chr(function(x) return(str_c(stringi::stri_conv(base_path,\"GBK\",\"UTF-8\"),stringi::stri_conv(x,\"UTF-8\"))))\n  da_path <- data.table(\"paths\" = all_paths)\n  \n  # for (i in c(1:length(all_paths))){\n  #   print(all_paths[i])\n  # test_da  <-fread(all_paths[i],encoding = 'UTF-8',skip=19)%>% as.data.table()\n  # test_da[,\":=\"(款号= as.character(款号)),]\n  # colClasses_used <- sapply(test_da,class)\n  # print(length(colClasses_used))\n  # }\n  \n  \n  da_path[,\":=\"(submix = str_sub(paths,-3,-1)),]\n  #  csv file \n  csv_paths_all <- da_path[submix=='csv',paths,]\n  \n  # type(colClasses_used)\n  csv_paths_all_da  <-csv_paths_all %>%  map_df(function(x) return(fread(x,skip=19,encoding = 'UTF-8',colClasses = c('character','character','character','character',\n                                                                                                                     'character','integer','integer','character',\n                                                                                                                     'character', 'integer','character','integer',\n                                                                                                                    'character','character','character','integer',\n                                                                                                                    'character','numeric','numeric','numeric'\n                                                                                                  )))) %>% as.data.table()\n  \n  csv_paths_all_da[,\":=\"(\"款号\"= as.character(款号)),]\n  \n  #  xls file\n  xls_paths_all <- da_path[submix=='lsx',paths,]\n  \n  if (length(xls_paths_all) >0){\n    xls_paths_all_da  <- xls_paths_all %>% map_df(function(x) {return(read_xlsx(x,sheet='分析 1',skip=3,col_types =c(\"text\",\"text\",\"text\",\"text\",\"text\",\"numeric\",\"numeric\",\"text\",\"text\",\n                                                                                                                   \"numeric\",\"text\",\"numeric\",\"text\",\"text\",\"text\",\"text\",\"numeric\",\"numeric\",\"numeric\")))}) %>% as.data.table()\n    \n    Ori_da <- bind_rows(csv_paths_all_da,xls_paths_all_da) %>%as.data.table()\n    rm(csv_paths_all_da,xls_paths_all_da)\n    \n  } else{\n    \n    \n    Ori_da <- csv_paths_all_da %>%as.data.table()\n    rm(csv_paths_all_da)\n  }\n  \n  \n  \n  setnames(Ori_da,names(Ori_da),c('qudao','area','agent','provi','shopid','ymd','sellid','season','bigtype','bigtypeid','midtype','midtypeid',\n                                  'smalltype','smalltypeid','sku','color','sex','lssl','lsje','lssz'))\n  \n  # rseason_pp <- fread(\"E:\\\\xh\\\\pp\\\\产品季节.txt\") %>% setnames(c('产品季','新季节'),c(\"season\",\"season_new\"))\n  # sku_pp <-  fread(\"E:\\\\xh\\\\pp\\\\引流款数据.txt\") %>% setnames(c('商品编号','款属性'),c(\"sku\",\"sku_yinlin\"))\n  # sku_pp[,\":=\"(sku = as.character(sku)),]\n  # \n  # \n  # Ori_da_A <- Ori_da %>% left_join(season_pp,by=c('season')) %>% left_join(sku_pp,by=c('sku'))  %>% as.data.table()\n  # rm(Ori_da)\n  \n  Ori_da[,\":=\"(unique_sellid = str_c(shopid,sellid,ymd,sep=\"-\")),]\n  Ori_da[,\":=\"(sell_type = str_c(bigtype,midtype,smalltype,sex,sku,color,sep = '-')),]\n  \n  return (Ori_da)\n}\nsupport_Sel >0.0001\nRead_da <- copy(tem)\nget_All_Aproior_zouDa <- function(Read_da = Ori_da,support_Sel = NULL,confidence_Sel = NULL){\n  Used_da <- Read_da[,.(unique_sellid,sell_type),]\n  Used_da_apri_input <- Used_da[!duplicated(Used_da),,]\n  if (dim(Used_da_apri_input)[1] ==0){\n    return (NULL);\n  }\n  Ori_Trans <- as(Used_da_apri_input[,.(val = list(sell_type)),by=.(unique_sellid)][,.(val),][[1]],'transactions')\n  \n  if (is.null(support_Sel)){\n    leng_item <- Read_da[,.N,]\n    min_fre_item <- Read_da[,.N,by=.(sell_type)][order(N)][1,2]#求出单项最小支持度极端???\n    max_fre_item <- Read_da[,.N,by=.(sell_type)][order(-N)][1,2]#求出单项最小支持度极端???\n    min_fre_feq<- min_fre_item/leng_item\n    max_fre_feq <- max_fre_item/leng_item\n    # 28原则选择置信???\n    # support_Sel <- as.vector(min_fre_feq +(max_fre_feq-min_fre_feq)/10*1)[[1]]\n    support_Sel <- (as.vector(min_fre_feq +(max_fre_feq-min_fre_feq)/10*1)[[1]])^2\n  }\n  if (is.null(confidence_Sel)){\n    confidence_Sel = support_Sel\n  }\n  # (Ori_Trans)@data@Dim[2] 事务的组合数和item\n  # summary(Ori_Trans)\n  Re_Ruels <- apriori(Ori_Trans,parameter = list(support = support_Sel,confidence = confidence_Sel,target=\"rules\",maxlen=3))\n\n  length_rules <- (Re_Ruels)@rhs@data@Dim[2]\n  if (length_rules >100000){\n    tem_re <- as.data.table(as(Re_Ruels[1:50000],'data.frame'))\n  }else{\n    tem_re <- as.data.table(as(Re_Ruels,'data.frame'))\n  }\n  # \n  # \n  tem_re[,\":=\"(rules = as.character(rules)),]\n  tem_re[,\":=\"(lhs = plyr::laply(rules,function (da){ return (str_split(da,' => ')[[1]][1])}),\n               rhs = plyr::laply(rules,function (da){ return (str_split(da,' => ')[[1]][2])})),]\n\n  # setcolorder(tem_re,c('tag','lhs','rhs','support','confidence','lift'))\n  setcolorder(tem_re,c('lhs','rhs','support','confidence','lift'))\n  # return(tem_re)\n  \n  return (tem_re)\n}\n\n\ndeal_lhs_rhs <- function(x,type = 1){\n  length_len <- nchar(x)\n  if (length_len <=2){\n    return ((NA))\n  }else if(length_len>2){\n    if(type == 1){\n      return (str_split(str_sub((x),2,-2),'-')[[1]][1])\n    }else if (type == 2){\n      return (str_split(str_sub((x),2,-2),'-')[[1]][2])\n    }else if(type == 3){\n      return (str_split(str_sub((x),2,-2),'-')[[1]][3])\n    }else if (type == 4 ){\n      return (str_split(str_sub((x),2,-2),'-')[[1]][4])\n    }else if (type == 5 ){\n      return (str_split(str_sub((x),2,-2),'-')[[1]][5])\n    }\n    else if (type == 6 ){\n      return (str_split(str_sub((x),2,-2),'-')[[1]][6])\n    }\n  }\n}\n\n\nget_Final_da <- function(data_x,support_Sel_ori = NULL,confidence_Sel_ori = NULL){\n  tem_re <- data_x %>% get_All_Aproior_zouDa(support_Sel = support_Sel_ori,confidence_Sel = confidence_Sel_ori) %>% as.data.table()\n  tem_split<- tem_re[,\":=\"(lhs_sex= sapply(lhs,deal_lhs_rhs,4),\n                           lhs_middle_rhs = sapply(lhs,deal_lhs_rhs,2),\n                           lhs_sku = sapply(lhs,deal_lhs_rhs,5),\n                           lhs_color = sapply(lhs,deal_lhs_rhs,6),\n                           # lhs_neiwaida = sapply(lhs,deal_lhs_rhs,5),\n                           rhs_sex= sapply(rhs,deal_lhs_rhs,4),\n                           rhs_middle_rhs = sapply(rhs,deal_lhs_rhs,2),\n                           rhs_sku = sapply(rhs,deal_lhs_rhs,5),\n                           rhs_color = sapply(rhs,deal_lhs_rhs,6)\n                           # ,\n                           # rhs_neiwaida = sapply(rhs,deal_lhs_rhs,5)\n  ),]\n  \n  tem_split <- as.data.table(tem_split)\n  tem_split_out <-tem_split[!is.na(lhs_middle_rhs),,][,.(lhs_sex,lhs_middle_rhs,lhs_sku,lhs_color,rhs_sex,rhs_middle_rhs,rhs_sku,rhs_color,support,confidence,lift),]\n  tem_split_out[,':='(lhs_color=str_replace(lhs_color,\",服装\",\"\")),]\n  \n  tem_split_input <- tem_split_out\n  tem_split_input[,\":=\"(lhs_color = sapply(lhs_color,deal_color),rhs_color = sapply(rhs_color,deal_color)),]\n  setorder(tem_split_input,lhs_sku,lhs_color,-support,-confidence,-lift)\n  tem_split_input[,\":=\"(intag =c(1:nrow(tem_split_input))),]\n  tem_split_input[,\":=\"(rank_sku_color = rank(intag,ties.method = 'first')),.(lhs_sku,lhs_color)]\n  tem_split_input[,\":=\"(intag = NULL),]\n  \n  return (tem_split_input)\n  \n}\n\ndeal_color <- function(x){\n  len_x <- nchar(x)\n  if (len_x==4){\n    return(str_c(x))\n  }else if(len_x==3){\n    return (str_c(\"0\",x))\n  }else if(len_x==2){\n    return (str_c(\"00\",x))\n  }else if(len_x==1){\n    return (str_c(\"000\",x))\n  }else{\n    return (str_c(x))\n  }\n}\n# base_path <- 'C:\\\\Users\\\\hasee\\\\Desktop\\\\aproiri\\\\18S56\\\\data\\\\'\nbase_path <- 'F:\\\\20180806\\\\aproiri\\\\18S56\\\\data\\\\'\ntem <- get_All_da(base_path) %>% as.data.table() \ntem[,.N,season]\ntem[,.N,ymd][order(ymd)]\ntem[,.N,area]\n\ntem[,.N,ymd][order(ymd)]\ntem[,.N,season][order(season)]\ntem[,.N,bigtype]\n\n# filter data and concat type\n# write.csv(tem[,.N,.(bigtype,midtype)],\"clipboard\")\ntem <- tem[bigtype=='服装',,]\ntem <- tem[season!='2018S7',,]\npp_type_new <- fread('C:\\\\Users\\\\hasee\\\\Desktop\\\\类型匹配.txt')\n\n# tem_re <- get_All_da(base_path) %>% as.data.table()  %>% get_All_Aproior_zouDa() \ntem_re <- tem %>% get_All_Aproior_zouDa() \n\nrm(tem)\n# str(tem_split_input)\n# write.csv(tem_split_input,\"C:\\\\Users\\\\hasee\\\\Desktop\\\\zouda_fs.txt\")\n\n# \n# tem_re[,unique(ymd),]\n# tem_re[,unique(season),]\n# # tem_re[season==\"2018S7\",,]\n# deal_lhs_rhs(\"{配件-包-斜挎包-女-15058530003-134}\",1) # big type\n# deal_lhs_rhs(\"{配件-包-斜挎包-女-15058530003-134}\",2) # mid type\n# deal_lhs_rhs(\"{配件-包-斜挎包-女-15058530003-134}\",3) # small type\n# deal_lhs_rhs(\"{配件-包-斜挎包-女-15058530003-134}\",4) # sex\n# deal_lhs_rhs(\"{配件-包-斜挎包-女-15058530003-134}\",5) # sku\n# deal_lhs_rhs(\"{配件-包-斜挎包-女-15058530003-134}\",6)# color\n# \ntem_split<- tem_re[,\":=\"(lhs_sex= sapply(lhs,deal_lhs_rhs,4),\n             lhs_middle_rhs = sapply(lhs,deal_lhs_rhs,2),\n             lhs_sku = sapply(lhs,deal_lhs_rhs,5),\n             lhs_color = sapply(lhs,deal_lhs_rhs,6),\n             # lhs_neiwaida = sapply(lhs,deal_lhs_rhs,5),\n             rhs_sex= sapply(rhs,deal_lhs_rhs,4),\n             rhs_middle_rhs = sapply(rhs,deal_lhs_rhs,2),\n             rhs_sku = sapply(rhs,deal_lhs_rhs,5),\n             rhs_color = sapply(rhs,deal_lhs_rhs,6)\n             # ,\n             # rhs_neiwaida = sapply(rhs,deal_lhs_rhs,5)\n             ),]\ntem_split <- as.data.table(tem_split)\ntem_split_out <-tem_split[!is.na(lhs_middle_rhs),,][,.(lhs_sex,lhs_middle_rhs,lhs_sku,lhs_color,rhs_sex,rhs_middle_rhs,rhs_sku,rhs_color,support,confidence,lift),]\ntem_split_out[,':='(lhs_color=str_replace(lhs_color,\",服装\",\"\")),]\ntem_split_out[,\":=\"(lhs_sku=str_replace(lhs_sku,\",配件\",\"\")),]\ntem_split_out[,':='(rhs_color=str_replace(rhs_color,\",服装\",\"\")),]\ntem_split_out[,\":=\"(rhs_sku=str_replace(rhs_sku,\",配件\",\"\")),]\nstr(tem_split)\n# write.csv(tem_split_out,'C:\\\\Users\\\\hasee\\\\Desktop\\\\zouda_0807.csv')\n# tem_split_input <- fread('C:\\\\Users\\\\hasee\\\\Desktop\\\\zouda_0807.csv')\ntem_split_input <- tem_split_out\n# \n# \n\n# \n# # deal_color(\"20\")\n# \ntem_split_input[,\":=\"(lhs_color = sapply(lhs_color,deal_color),rhs_color = sapply(rhs_color,deal_color)),]\nsetorder(tem_split_input,lhs_sku,lhs_color,-support,-confidence,-lift)\ntem_split_input[,\":=\"(intag =c(1:nrow(tem_split_input))),]\ntem_split_input[,\":=\"(rank_sku_color_support = rank(intag,ties.method = 'first')),.(lhs_sku,lhs_color)]\ntem_split_input[,\":=\"(intag = NULL),]\n\npp_type_new <- fread('C:\\\\Users\\\\hasee\\\\Desktop\\\\类型匹配.txt')\nsetnames(pp_type_new,c('midtype','TYPE_S_X'),c('lhs_middle_rhs','lhs_middle_S_X'))\n# setnames(pp_type_new,c('midtype','TYPE_S_X'),c('rhs_middle_rhs','rhs_middle_S_X'))\n\ntem_split_input <- tem_split_input %>% left_join(pp_type_new[,2:3],by=c('lhs_middle_rhs')) %>% as.data.table()\n\npp_type_new <- fread('C:\\\\Users\\\\hasee\\\\Desktop\\\\类型匹配.txt')\nsetnames(pp_type_new,c('midtype','TYPE_S_X'),c('rhs_middle_rhs','rhs_middle_S_X'))\ntem_split_input <- tem_split_input %>% left_join(pp_type_new[,2:3],by=c('rhs_middle_rhs')) %>% as.data.table()\n\n# only Shang\ntem_split_input[lhs_middle_S_X=='上装'&(lhs_middle_rhs!=rhs_middle_rhs),,]\ntem_split_input[lhs_middle_S_X=='上装'&rhs_middle_S_X=='下装',,]\n# only xia\ntem_split_input[lhs_middle_S_X=='下装'&(rhs_middle_S_X=='上装'),,]\n\n42554+21406+ 20236\n\ntem_Da <- \nbind_rows(\n  tem_split_input[(lhs_middle_S_X=='上装')&(rhs_middle_S_X=='上装')&(lhs_middle_rhs!=rhs_middle_rhs),,],\n  tem_split_input[(lhs_middle_S_X=='上装')&(rhs_middle_S_X=='下装')&(lhs_middle_rhs!=rhs_middle_rhs),,],\n  tem_split_input[(lhs_middle_S_X=='下装')&(rhs_middle_S_X=='上装')&(lhs_middle_rhs!=rhs_middle_rhs),,]\n)\ntem_split_input <- tem_Da[!duplicated(tem_Da)]\n# unique(tem_re$lhs_neiwaida)\n# unique(tem_re$color)\n# tem_split_input[lhs_sku==\"18058041904\",,]\n \n# str(tem_split_input)\n# write.csv(tem_split_input,\"C:\\\\Users\\\\hasee\\\\Desktop\\\\zouda_fs.txt\")\n# write.csv(tem_split_input,'F:\\\\20180806\\\\aproiri\\\\18S56\\\\data\\\\lele_0820.csv')\n# tem_split_input <- fread('F:\\\\20180806\\\\aproiri\\\\18S56\\\\data\\\\lele_0820.csv')\n# str(tem_split_input)\nsetorder(tem_split_input,lhs_sku,lhs_color,-support,-confidence,-lift)\n# tem_split_input[,,][order(lhs_sku,lhs_color,support)]\n# xlsx::write.xlsx(tem_split_input,\"F:\\\\20180806\\\\aproiri\\\\18S56\\\\data\\\\lele_0820.xlsx\")\n# tem_split_input <- xlsx::read.xlsx(\"F:\\\\20180806\\\\aproiri\\\\18S56\\\\data\\\\lele_0820.xlsx\",sheetIndex = 1)\ntem_split_input <- tem_split_input[,,][order(lhs_sku,lhs_color,-support)]\ntem_split_input_used<- tem_split_input[lhs_middle_rhs!=rhs_middle_rhs,,]\ntem_split_input_used[,\":=\"(rank_sku_color_support = frank(-support,ties.method = 'first')),.(lhs_sku,lhs_color)]\ntem_split_input_used <- tem_split_input_used[rank_sku_color_support<=20,,]\ntem_split_input_used<- tem_split_input_used[,,][order(lhs_sku,lhs_color,-lift)]\ntem_split_input_used[,':='(rank_sku_color_support=NULL),]\ntem_split_input_used[,\":=\"(rank_sku_color_lift = frank(-lift,ties.method = 'first')),.(lhs_sku,lhs_color)]\n# fivenum(tem_Da[,confidence,])\n# tem_Da[confidence==1,,]\nxlsx::write.xlsx(tem_split_input_used,\"F:\\\\20180806\\\\aproiri\\\\18S56\\\\data\\\\aprior_0910_S5S6.xlsx\")\n#---- xiapo tag in all tem----\ntem_split_input_used <- xlsx::read.xlsx(\"F:\\\\20180806\\\\aproiri\\\\18S56\\\\aprior_0910.xlsx\",sheetIndex = 1)\n",
    "created" : 1536564155676.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "4234217859",
    "id" : "D9FDA28B",
    "lastKnownWriteTime" : 1536564279,
    "last_content_update" : 1536564279947,
    "path" : "E:/Rworkspace/month3_18/Report_Apriori/apriori/zouda_aprioir.R",
    "project_path" : null,
    "properties" : {
    },
    "relative_order" : 4,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}