{
    "collab_server" : "",
    "contents" : "library(tidyverse)\nlibrary(data.table)\nlibrary(RMySQL)\n\ncon <- dbConnect(MySQL(),host=\"127.0.0.1\",dbname=\"smnews\",user=\"root\",password=\"\") \ndbListTables(con)\ndbSendQuery(con,'SET NAMES gbk')\nnew_his_old <- data.table(dbReadTable(con,'history_tem'))\nnew_his_new <- data.table(dbReadTable(con,'month_later_180128'))\n\n# data in both city\nnew_his_new[,.N,ymd]\n# new_his_old <- new_his_old[(ymd>=2017080606&ymd<=20171005)|(ymd>=20180806&ymd<=20180906),,]\nnew_his_old <- new_his_old[(ymd>=20170906&ymd<=20171005),,]\nboth_city <- intersect(unique(unlist(new_his_new$city)),unique(unlist(new_his_old$area_name)))\n\nnew_his_new_used <- new_his_new[city%in%both_city,,]\nnew_his_old_used <- new_his_old[area_name%in%both_city,,]\n\nstr(new_his_new_used)\n\n# data pipei area\nnew_his_old_used[,c(\"provi\",\"area\",\"area_name\",\"s_area\"):=NULL]   #删除数据\nPipi <- fread(file = 'C:\\\\Users\\\\hasee\\\\Desktop\\\\ppb.txt',encoding = 'UTF-8') \nnew_his_old_used<-data.table(left_join(new_his_old_used,Pipi,by=\"city\"))\nnew_his_old_used[,.N,by=.(s_area)]  #观察是否有失误数据\nnew_his_old_used[s_area==\"无小区\",.N,by=.(area_name)]  #观察是否有失误数据\n\n\nsetnames(Pipi,names(Pipi),c('area_name','provi','area','s_area','city'))\nnew_his_new_used[,\":=\"(area=NULL,s_area=NULL),]\nnew_his_new_used<-data.table(left_join(new_his_new_used,Pipi[,.(city,area,s_area),],by=\"city\"))\nnew_his_new_used[,.N,by=.(s_area)]  #观察是否有失误数据\nnew_his_new_used[s_area==\"无小区\",.N,by=.(area)]  #观察是否有失误数据\n\n# qing yin yu\n## old data\nnew_his_old_used[is.na(tianqi_am),,]\nnew_his_old_used[is.na(tianqi_pm),,]\nnew_his_old_used[tianqi_am=='=-',,]\nnew_his_old_used[tianqi_pm=='=-',,]\n\ntian_qi_pm <- sort(unique(new_his_old_used$tianqi_pm))\ntian_qi_pm_sd <- c(\"暴雪\",\"暴雨\",\"大暴雨\",\"大到暴雪\",\"大雪\",\"大雪-暴雪\",            \"大雨\",\"大雨-暴雨\",\"冻毛毛雨\",\"冻雨\",\"多云\",\"刮风\",     \n                   \"局部多云\",\"零散阵雨\",\"霾\",\"晴\",\"少云\",\"雾\",                       \"小到中雪\",\"小到中雨\",\"小雪\",\"小雪-中雪\",\"小雨\",\"小雨-中雨\",\n                   \"雪\",\"扬沙\",\"阴\", \"阴天\", \"雨\",\"雨夹雪\",                           \"阵雪\",\"阵雨\",\"中到大雪\", \"中到大雨\",\"中雪\",\"中雪-大雪\",\n                   \"中雨\",\"中雨-大雨\",\"浮尘\",\"雷阵雨\",\"沙尘暴\",                     \"大到暴雨\",\"阵雨1\", \"特大暴雨\",\"雷阵雨伴有冰雹\",  \"零散雷雨\" ,\"雷雨\",\n                   \"零散阵雪\",\"雨雪混合\",\"少云\",\"暴雨到大暴雨\",\"强沙尘暴\",\"-\",\n                   \"=-\",        \"薄雾\" ,      \"冰雨\"     ,  \"局部雷雨\" ,  \"毛毛雨细雨\",\n                   \"强阵雨\",     \"晴间多云\",   \"小到大雪\"  , \"阵雨夹雪\"  )\nsetdiff(tian_qi_pm,tian_qi_pm_sd)\ntian_qi_yu_fou_pm_sd <- c(\"雪\",\"雨\",\"雨\",\"雪\",\"雪\",\"雪\",    \"雨\",\"雨\",\"雨\",\"雨\",\"晴\",\"晴\",\n                          \"晴\",\"雨\",\"阴\",\"晴\",\"晴\",\"阴\",    \"雪\",\"雨\",\"雪\",\"雪\",\"雨\",\"雨\",\n                          \"雪\",\"阴\",\"阴\",\"阴\",\"雨\",\"雪\",    \"雪\",\"雨\",\"雪\",\"雨\",\"雪\",\"雪\",\n                          \"雨\",\"雨\",\"阴\",\"雨\",\"阴\",         \"雨\",\"雨\",\"雨\",\"雨\",\"雨\",\"雨\",\n                          \"雪\", \"雪\",\"晴\",\"雨\",\"阴\",\"晴\",\n                          \"阴\",\"晴\",\"雨\",\"雨\",\"雨\",          \"雨\",\"晴\",\"雪\",\"雨\")\n\nNPiPmT <- data.table('tianqi_pm' = tian_qi_pm_sd,\"qy\" = tian_qi_yu_fou_pm_sd) # 匹配表\nwrite.csv(NPiPmT,'clipboard')\nnew_his_old_used <-as.data.table(left_join(new_his_old_used,NPiPmT,by='tianqi_pm'))\n\n\n\n\n## new data\nnew_his_new_used[is.na(tianqi_pm),,]\nNPiPm<- as.data.table(read.csv('C:\\\\Users\\\\hasee\\\\Desktop\\\\PP_QYN.txt',stringsAsFactors = FALSE,sep ='\\t'))[,.(tianqi_pm,qy),]\n\nsetdiff(as.vector(unlist(new_his_new_used$tianqi_pm)),NPiPm$tianqi_pm)\nnew_his_new_used <-as.data.table(left_join(new_his_new_used,NPiPm,by='tianqi_pm'))\n\nnew_his_new_used[is.na(qy),.(unique(tianqi_pm)),]\n\n#------------------new da final----------------\nnew_his_new_used[,.N,.(ymd)]\nnew_his_old_used[,.N,.(ymd)]\nnew_his_old_used[year==2017,.N,.(ymd)]\nnew_his_old_used[,.N,year]\nnew_his_old_used[ymd>=20170806&ymd<=20170906,,][,.N,ymd]\nstr(new_his_old_used)\n\nnew_final_da <- bind_rows(new_his_new_used[,.(year,month,day,ymd,city,provi,area,s_area,ave_tm,qy),],\n          new_his_old_used[,.(year,month,day,ymd,city,provi,area,s_area,ave_tm,qy),]) %>% as.data.table()\n\nnew_final_da <- ttt[(ymd>=20171001&ymd<=20171005)|(ymd>=20181001&ymd<=20181005),,]\nttt <- copy(new_final_da)\nnew_final_da <- ttt\n\nnew_final_da[,.N,qy]\nnew_final_da[qy==\"雪\",\":=\"(qy='雨'),]\nnew_final_da[,\":=\"(md=str_sub(ymd,5,8)),]\nnew_final_da[,\":=\"(ave_tm = as.numeric(ave_tm)),]\n\n#----------- sheet one -----------------------\n## tianqi\nqy_zhanbi <- new_final_da[,.(qy_N = .N),.(qy,year)]\nqy_zhanbi[,\":=\"(all_N = sum(qy_N)),.(year)]\nqy_zhanbi[,\":=\"(zb = qy_N/all_N),]\n\ndcast.data.table(qy_zhanbi[,.(qy,year,zb),],qy~year)\n\n\n## qingyu\ndcast.data.table(new_final_da[,.(ave_tm = mean(ave_tm,na.rm = TRUE)),.(qy,year)],\n                 qy~year)\nnew_final_da[,.(ave_tm = mean(ave_tm,na.rm = TRUE)),.(year)]\n\n## tianqi area five\nqy_zhanbi <- new_final_da[,.(qy_N = .N),.(qy,year,area)]\nqy_zhanbi[,\":=\"(all_N = sum(qy_N)),.(year)]\nqy_zhanbi[,\":=\"(zb = qy_N/all_N),]\n\nqy_zhanbi[qy=='晴',,]\nwrite.csv(qy_zhanbi[qy=='晴',,],'clipboard')\n\n## qingyu  area five\nnew_final_da[,.(ave_tm = mean(ave_tm,na.rm = TRUE)),.(area,year)]\nwrite.csv(new_final_da[,.(ave_tm = mean(ave_tm,na.rm = TRUE)),.(area,year)],'clipboard')\n\n## tem  day\npp_sheet <- data.table(md = unique(new_final_da$md),day_index = c(1:30))\nnew_final_da <- left_join(new_final_da,pp_sheet,by=c('md')) %>%  as.data.table()\nnew_final_da[,.(ave_tm = mean(ave_tm,na.rm = TRUE)),.(year,day_index)][order(year,day_index)]\nwrite.csv(new_final_da[,.(ave_tm = mean(ave_tm,na.rm = TRUE)),.(year,day_index)][order(year,day_index)],'clipboard')\n\n##  tem qingyu\ntem <- new_final_da[,.(count_qy = .N),.(year,day_index,qy)]\ntem[,\":=\"(count_qy_all = sum(count_qy)),.(year,day_index)]\ntem[,\":=\"(zhanbi=count_qy/count_qy_all),]\ntem[qy==\"晴\",,]\nwrite.csv(tem[qy==\"晴\",,],'clipboard')\n\n\n\n\n#----------- sheet two -----------------------\n## tianqi\nqy_zhanbi <- new_final_da[,.(qy_N = .N),.(qy,year,provi)]\nqy_zhanbi[,\":=\"(all_N = sum(qy_N)),.(year,provi)]\nqy_zhanbi[,\":=\"(zb = qy_N/all_N),]\n\nwrite.csv(qy_zhanbi,'clipboard')\n\n## qingyu\nnew_final_da[,.(ave_tm = mean(ave_tm,na.rm = TRUE)),.(year,qy,provi)]\nnew_final_da[,.(ave_tm = mean(ave_tm,na.rm = TRUE)),.(year,provi)]\nwrite.csv(,'clipboard')\n\n## tianqi five area\nqy_zhanbi <- new_final_da[,.(qy_N = .N),.(qy,year,area)]\nqy_zhanbi[,\":=\"(all_N = sum(qy_N)),.(year,area)]\nqy_zhanbi[,\":=\"(zb = qy_N/all_N),]\n\nwrite.csv(qy_zhanbi,'clipboard')\n\n## qingyu\nnew_final_da[,.(ave_tm = mean(ave_tm,na.rm = TRUE)),.(year,qy,provi)]\nnew_final_da[,.(ave_tm = mean(ave_tm,na.rm = TRUE)),.(year,provi)]\nwrite.csv(new_final_da[,.(ave_tm = mean(ave_tm,na.rm = TRUE)),.(year,provi)],'clipboard')\n\n\n## tem  day\n\ntem <- new_final_da[,.(ave_tm = mean(ave_tm,na.rm = TRUE)),.(year,provi,day_index)][order(year,day_index)]\n\n# 总监例会\ntem <- new_final_da[,.(ave_tm = mean(ave_tm,na.rm = TRUE)),.(provi,ymd,year)][order(provi,ymd)]\nwrite.csv(tem,'F:\\\\20180806\\\\总监例会\\\\aaa.csv')\n\n##  tem qingyu\ntem <- new_final_da[,.(count_qy = .N),.(year,day_index,provi,qy)]\ntem[,\":=\"(count_qy_all = sum(count_qy)),.(year,day_index,provi)]\ntem[,\":=\"(zhanbi=count_qy/count_qy_all),]\ntem[qy==\"晴\",,]\nwrite.csv(tem[qy==\"晴\",,],'C:\\\\Users\\\\hasee\\\\Desktop\\\\aaa\\\\day_qt.csv')\n\n\n\n#------------ sheet three \n\n## lszb\nlssl_new_old <- fread('C:\\\\Users\\\\hasee\\\\Desktop\\\\天省份零售_0907.csv',skip=13,encoding = 'UTF-8')\nls_da_old<- lssl_new_old %>% select(1:11) %>% filter(产品季%in%c('2017S5','2017S6','2017S7'))%>% filter(当期零售数量>0) %>% as.data.table()\nls_da_new <- lssl_new_old %>% select(1:8,12:14) %>% filter(产品季%in%c('2018S5','2018S6','2017S7')) %>% filter(零售数量同期 > 0) %>% as.data.table()\nsetnames(ls_da_old,c('当期零售数量','当期零售金额','当期零售市值'),c('sl','je','sz'))\nsetnames(ls_da_new,c('零售数量同期','零售金额同期','零售市值同期'),c('sl','je','sz'))\nls_da <- as.data.table(bind_rows(ls_da_old,ls_da_new))\n\nls_da_old_used <- ls_da[日历天>=20170906&日历天<=20171005&产品季%in%c(\"2017S5\",\"2017S6\",\"2017S7\"),,][门店渠道名称=='加盟',.(hjsl = sum(sl,na.rm = TRUE),hjsz=sum(sz,na.rm = TRUE),hjje = sum(je,na.rm = TRUE)),by=.(中类,省份名称,日历天)][order(日历天,省份名称,中类)]\n\npp_data <- fread('C:\\\\Users\\\\hasee\\\\Desktop\\\\jiejiari.txt')[,.(ymd,班休,星期),]\nsetnames(pp_data,'ymd','日历天')\n\nfinal_da <- as.data.table(left_join(ls_da_old_used,pp_data,by='日历天'))\nsetnames(final_da,'日历天','ymd')\nsetnames(final_da,'省份名称','provi')\nsetnames(final_da,'中类','midtype')\n\nday_lszb <- final_da[,.(lssl = sum(hjsl,na.rm=TRUE)),.(provi,midtype,ymd)]\nday_lszb[,\":=\"(lssl_all = sum(lssl,na.rm = TRUE)),.(provi,midtype)]\nday_lszb[,\":=\"(lszb = lssl/lssl_all),]\n\npp_sheet <- data.table(ymd = unique(day_lszb$ymd),day_index = c(1:30))\nday_lszb <- left_join(day_lszb,pp_sheet,by=c('ymd')) %>%  as.data.table()\n\nwrite.csv(day_lszb,\"C:\\\\Users\\\\hasee\\\\Desktop\\\\aaa\\\\day_ls.csv\")\n## tem da 2017 2018\n\nda_day_ave <- new_final_da[,.(ave_tm = mean(ave_tm,na.rm = TRUE)),.(provi,ymd,year)]\nda_day_ave[year=='2017',.(provi,ymd,ave_tm,year),][order(provi,ymd)]\n# write.csv(da_day_ave[year=='2017',.(provi,ymd,ave_tm,year),][order(provi,ymd)],\"C:\\\\Users\\\\hasee\\\\Desktop\\\\aaa\\\\day_tem_2017.csv\")\n# write.csv(da_day_ave[year=='2018',.(provi,ymd,ave_tm,year),][order(provi,ymd)],\"C:\\\\Users\\\\hasee\\\\Desktop\\\\aaa\\\\day_tem_2018.csv\")\n\n## shixiao tem\ntem_17 <- da_day_ave[year=='2017',.(provi,ymd,ave_tm,year),][order(provi,ymd)][,.(provi,ymd,ave_tm),]\nfinal_da_tem <- final_da  %>% left_join(tem_17,by=c('provi','ymd')) %>% as.data.table()\nfinal_da_tem_used <- final_da_tem[班休=='班',,]\n\nsetorder(final_da_tem,-midtype,provi,ave_tm)\n#添加温度排序从高到依\nfinal_da_tem_used_Proc<-final_da_tem_used[,\":=\"(rank_tm = rank(-ave_tm,ties.method = \"first\")),by=.(midtype,provi)][order(midtype,provi,ave_tm)]\n#添加零售排序从高到低\nfinal_da_tem_used_Proc<-final_da_tem_used_Proc[,\":=\"(rank_ls = rank(-hjsz,ties.method = \"first\")),by=.(midtype,provi)][order(midtype,provi,hjsz)]\n#添加温度排序前后的值\nfinal_da_tem_used_Proc[,\":=\"(rank_tm_jian1=rank_tm-1),]\nfinal_da_tem_used_Proc[,\":=\"(rank_tm_jia1 = rank_tm+1),]\n#添加温度的匹配表\n\ntemPP<- final_da_tem_used_Proc[,.(provi,midtype,ave_tm,rank_tm),]\n#添加减的温度\nadd_temPP_jian <- temPP[rank_tm==1,,]\nadd_temPP_jian[,\":=\"(rank_tm=0),]\n\n#添加加的的温度\n#添加减的温度\nadd_temPP_jia_ori <- temPP[,.(rank_tm= max(rank_tm)),by=.(provi,midtype)]\nadd_temPP_jia_ori[,\":=\"(add = 1)]\nadd_temPP_jia <- data.table(left_join(temPP,add_temPP_jia_ori,by=c(\"provi\",\"midtype\",\"rank_tm\")))[add==1,][,.(provi,midtype,ave_tm,rank_tm)]\nadd_temPP_jia[,\":=\"(rank_tm_new=rank_tm+1)]\nadd_temPP_jia[,c(\"rank_tm\"):=NULL]\nsetnames(add_temPP_jia,\"rank_tm_new\",\"rank_tm\")\n#把新的温度添加上前去\ntemPP <- data.table(dplyr::bind_rows(bind_rows(add_temPP_jian,add_temPP_jia),temPP))\n\n\n\nfinal_tem  <-left_join(left_join(final_da_tem_used_Proc,temPP,by=c(\"provi\"=\"provi\",\"midtype\"=\"midtype\",\"rank_tm_jian1\"=\"rank_tm\"),suffix=c(\"_min_tm\",\"_min_tem2\")),\n                       temPP,by=c(\"provi\"=\"provi\",\"midtype\"=\"midtype\",\"rank_tm_jia1\"=\"rank_tm\"),suffix=c(\"_max_tm\",\"_max_tem2\"))\ndata.table(final_tem)[rank_ls ==1,]\n\nwrite.csv(data.table(final_tem)[rank_ls ==1,],'C:\\\\Users\\\\hasee\\\\Desktop\\\\aaa\\\\shixiao_tem.csv')\n\nnew_final_da[,.N,ymd]\nwrite.csv(new_final_da[,.(min=min(ave_tm,na.rm = TRUE),max = max(ave_tm,na.rm = TRUE)),.(year,provi)][order(year,provi)],\n          \"clipboard\")\nunique(new_final_da[,.(provi,area),])\n",
    "created" : 1536287064469.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "2473709978",
    "id" : "EBB85CB2",
    "lastKnownWriteTime" : 1536303433,
    "last_content_update" : 1536303433,
    "path" : "E:/Rworkspace/month3_18/HistoryTemAna/BaoBiao_Month_Weather.R",
    "project_path" : null,
    "properties" : {
        "source_window_id" : ""
    },
    "relative_order" : 2,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}