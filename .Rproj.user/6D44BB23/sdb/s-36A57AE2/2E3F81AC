{
    "collab_server" : "",
    "contents" : "library(tidyverse)\nlibrary(data.table)\nlibrary(RMySQL)\nlibrary(TTR)\nlibrary(lubridate)\n# ---- before deal---------\nhistory_tem <- history_tem[!duplicated(history_tem)]\n# --------base data----\n# hana 数据\n# hana_data <- fread('C:\\\\Users\\\\hasee\\\\Desktop\\\\wea_xiuzheng\\\\小票关联_门店基础信息_2018-09-04_11-35-15.csv',skip=19,encoding='UTF-8')\n# base_da_city  <- as.vector(unique(hana_data$城市名称))\n\nbase_path <- \"C:\\\\Users\\\\hasee\\\\Desktop\\\\wea_xiuzheng\\\\汇报天气特征\\\\城市新.txt\"\nhana_data <- fread(base_path)\nbase_da_city <- as.vector(unique(hana_data$城市名称))\n# 历史数据\ncon <- dbConnect(MySQL(),host=\"127.0.0.1\",dbname=\"smnews\",user=\"root\",password=\"\") \ndbSendQuery(con,'SET NAMES gbk')\nhistory_tem <- as.data.table(dbReadTable(con,'history_tem_jiaodui'))\nstr(history_tem)\nhistory_tem[,\":=\"(ave_tm = as.numeric(ave_tm),max_tm = as.numeric(max_tm),min_tm = as.numeric(min_tm)),]\nhistory_tem[,\":=\"(provi=NULL,area=NULL,s_area=NULL,area_name = NULL),]\nhistory_tem[,.N,year]\n\nhistory_tem[,\":=\"(provi=NULL,area=NULL,s_area=NULL,area_name = NULL),]\nppb_city <- fread('C:\\\\Users\\\\hasee\\\\Desktop\\\\ppb.txt',encoding = 'UTF-8')\nhistory_tem <- history_tem %>% left_join(ppb_city,by=c('city')) %>% as.data.table()\nhistory_tem[is.na(area_name),,]\n\n# 未来数据\ndbSendQuery(con,'SET NAMES gbk')\nhistory_tem_later <- as.data.table(dbReadTable(con,'month_later_180128'))\n\nstr(history_tem)\nstr(history_tem_later)\ntem_a <- as.vector(unique(history_tem$area_name))\ntem_b <- as.vector(unique(history_tem_later$city))\ntem_c <- as.vector(unique((hana_data$城市名称)))\n\n# c('图木舒克','伊宁','阿图什','二连浩特','云浮','萍乡') %in% ppb_city$area_name\n# write.csv(tem_b,'clipboard')\nppb_city[area_name%in%c('图木舒克','伊宁','阿图什','二连浩特','云浮','萍乡'),,]\nppb_city$area_name\n\ndplyr::intersect(intersect(tem_a,tem_c),tem_b)\ndplyr::intersect(tem_a,tem_c)\n#--------- deal----\nppb_sheet <- fread('C:\\\\Users\\\\hasee\\\\Desktop\\\\wea_xiuzheng\\\\共同城市匹配表.csv')\nsetnames(ppb_sheet,'HANA_ORI','城市名称')\nhana_data_new <- hana_data %>% left_join(ppb_sheet,by=c('城市名称')) %>% as.data.table()\nstr(hana_data_new)\nhana_data_new[,.N,HANA_DEAL]\n\nppb_sheet <- fread('C:\\\\Users\\\\hasee\\\\Desktop\\\\wea_xiuzheng\\\\共同城市匹配表.csv')\nsetnames(ppb_sheet,'HISTORY','area_name')\nhistory_tem_new <- history_tem %>% left_join(ppb_sheet,by=c('area_name')) %>% as.data.table()\nhistory_tem_new[!is.na(HANA_ORI),.N,HANA_ORI]\n\nppb_sheet <- fread('C:\\\\Users\\\\hasee\\\\Desktop\\\\wea_xiuzheng\\\\共同城市匹配表.csv')\nsetnames(ppb_sheet,'LATER','city')\nhistory_tem_later_new <- history_tem_later %>% left_join(ppb_sheet,by=c('city')) %>% as.data.table()\n\n#---------filter----\nhana_data_new[,.N,.(PROVI,HANA_DEAL)]\nhistory_tem_new_used <- history_tem_new[(!is.na(HANA_ORI))&HANA_ORI!=\"\"&(month%in%c(1,2,3,4,5,6,7,8,9,10,11,12))&(year%in%c(2016,2017)),,]\nhistory_tem_new_used <- history_tem_new_used %>% bind_rows(\nhistory_tem_new[(area_name%in%c('南京','武汉','海口','西宁','银川'))&(month%in%c(1,2,3,4,5,6,7,8,9,10,11,12))&(year%in%c(2016,2017)),,]\n) %>% as.data.table()\n\nhistory_tem_new_used[year==2018&month>=8,.(ave_tm = mean(ave_tm,na.rm=TRUE)),.(area_name,HANA_ORI,WEA_CAP,PROVI,ymd,year,month,day,yearweek)][,.N,ymd][order(ymd)]\nhistory_tem_new_used[,.N,area_name]\nhistory_tem_new_used[,.N,HANA_ORI]\nhistory_tem_new_used[,.N,ymd][order(ymd)]\n\n#------------write------\n# write.csv(\n#   history_tem_new_used[,.(ave_tm = mean(ave_tm,na.rm=TRUE)),.(area_name,HANA_ORI,WEA_CAP,PROVI,ymd,year,month,day,yearweek)][order(year,month,day)],\n#   'C:\\\\Users\\\\hasee\\\\Desktop\\\\wea_xiuzheng\\\\新的历史数据160101-171231.csv'\n# )\n\nhistory_tem_new_used\nhistory_tem_new_used[month%in%c(6,7,8,9,10,11,12),.(ave_tm = mean(ave_tm,na.rm=TRUE)),.(Filter,PROVI,ymd,year,month,day,yearweek)]\n# [,.N,.(Filter)][N<950,,]\n\nhistory_tem_new_used[,.N,.(ymd,provi)]\n\nfwrite(\n  history_tem_new_used[month%in%c(6,7,8,9,10,11,12),.(ave_tm = mean(ave_tm,na.rm=TRUE)),.(Filter,PROVI,ymd,year,month,day,yearweek)],\n  'C:\\\\Users\\\\hasee\\\\Desktop\\\\wea_xiuzheng\\\\city_both_145.csv'\n)\n\n\n\nhistory_tem_later_new_used<- history_tem_later_new[!is.na(Filter)&(month%in%c(5,6,7,8,9,10))&(year%in%c(2016,2017,2018)),,]\nhistory_tem_later_new_used[,\":=\"(ave_tm= as.numeric(ave_tm),yearweek = as.numeric(yearweek)),]\nhistory_tem_later_new_used[,.(ave_tm = mean(ave_tm,na.rm=TRUE)),.(Filter,ymd,year,month,day,yearweek)]\n\nxlsx::write.xlsx(history_tem_new_used[,.(ave_tm = mean(ave_tm,na.rm=TRUE)),.(provi,ymd,year,month,day,yearweek)],\n                 'C:\\\\Users\\\\hasee\\\\Desktop\\\\wea_xiuzheng\\\\filter\\\\old_three_years_captical.xlsx')\n\nxlsx::write.xlsx(history_tem_later_new_used[,.(ave_tm = mean(ave_tm,na.rm=TRUE)),.(provi,ymd,year,month,day,yearweek)],\n                 'C:\\\\Users\\\\hasee\\\\Desktop\\\\wea_xiuzheng\\\\filter\\\\new_month_captical.xlsx')\n\nhistory_tem_new_used[month%in%c(6,7,8),.(ave_tm = mean(ave_tm,na.rm=TRUE)),.(year,month)][order(month)]\n\nhistory_tem_later_new_used\n\n\n\n# ----------both city ---------\n\n\n",
    "created" : 1537942008729.000,
    "dirty" : false,
    "encoding" : "CP936",
    "folds" : "",
    "hash" : "1621876069",
    "id" : "2E3F81AC",
    "lastKnownWriteTime" : 1537420779,
    "last_content_update" : 1537420779,
    "path" : "D:/Program Files/RStudio/20180904_autter_data_deal.R",
    "project_path" : null,
    "properties" : {
    },
    "relative_order" : 4,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}